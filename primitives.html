<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>A-Frame Сфера из Кубов</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
</head>
<body>
    <style>
      #progress-bar {
        position: fixed;
        pointer-events: none;
        width: 60px;
        height: 6px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 3px;
        overflow: hidden;
        transform: translate(-50%, -150%);
        display: none;
        z-index: 9999;
      }
      #progress-bar-fill {
        height: 100%;
        width: 0%;
        background: #4CAF50;
      }
    </style>

    <a-scene>
        <!-- Прогресс бар -->
        <div id="progress-bar"><div id="progress-bar-fill"></div></div>
        <!-- Освещение -->
        <a-light type="ambient" color="#445451"></a-light>
        <a-light type="directional" position="2 10 -5" intensity="0.2" cast-shadow></a-light>

        <!-- Небо -->
        <a-sky color="#111933"></a-sky>

        <!-- Пол -->
        <a-plane position="0 0 -4" rotation="-90 0 0" width="50" height="50" color="#172920" shadow></a-plane>
        <a-sphere id="kidball" position="0 0.1 10" radius="0.5"></a-sphere>

        <!-- Камера -->
        <a-camera position="0 1.6 5">
            <a-cursor></a-cursor>
        </a-camera>

        <!-- Контейнеры -->
        <a-entity id="cube-sphere-container"></a-entity>
        <a-entity id="column-sphere-container1"></a-entity>
        <a-entity id="column-sphere-container2"></a-entity>
        <a-entity id="column-sphere-container3"></a-entity>
        <a-entity id="stalag-container"></a-entity>
        <a-cone color = "brown" height="5" position="0 16 0" rotation="180" animation__mouseenter="property: position; type: color; to: 0 -1 0; startEvents: mouseenter; dur: 500";></a-cone>
        <a-cone color = "brown" height="5" position="8 16 3" rotation="180" animation__mouseenter="property: position; type: color; to: 8 -1 3; startEvents: mouseenter; dur: 500";></a-cone>
        <a-cone color = "brown" height="5" position="-5 16 4" rotation="180" animation__mouseenter="property: position; type: color; to: -5 -1 4; startEvents: mouseenter; dur: 500";></a-cone>
        <a-entity id="waterdrops-container"></a-entity>
        <!-- Доп. источник света -->
        <a-light type="point" intensity="0.8" position="2 10 -5"></a-light>
    </a-scene>
    <script src="ball-interaction.js"></script>
    <script>
        // Ждем загрузки A-Frame
        document.addEventListener('DOMContentLoaded', function () {
            // Утилиты цвета
            function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }

            // hex -> {h,s,l} (s,l в %)
            function hexToHSL(H) {
                let r = 0, g = 0, b = 0;
                if (H.length === 4) {
                    r = parseInt(H[1] + H[1], 16);
                    g = parseInt(H[2] + H[2], 16);
                    b = parseInt(H[3] + H[3], 16);
                } else {
                    r = parseInt(H.slice(1, 3), 16);
                    g = parseInt(H.slice(3, 5), 16);
                    b = parseInt(H.slice(5, 7), 16);
                }
                r /= 255; g /= 255; b /= 255;

                const cmin = Math.min(r, g, b);
                const cmax = Math.max(r, g, b);
                const delta = cmax - cmin;

                let h = 0;
                if (delta !== 0) {
                    if (cmax === r) h = ((g - b) / delta) % 6;
                    else if (cmax === g) h = (b - r) / delta + 2;
                    else h = (r - g) / delta + 4;
                    h = Math.round(h * 60);
                    if (h < 0) h += 360;
                }
                const l = (cmax + cmin) / 2;
                const s = delta === 0 ? 0 : delta / (1 - Math.abs(2 * l - 1));
                return { h, s: s * 100, l: l * 100 };
            }

            // h(0..360), s/l в % -> hex
            function hslToHex(h, s, l) {
                h = ((h % 360) + 360) % 360;
                s = clamp(s / 100, 0, 1);
                l = clamp(l / 100, 0, 1);

                const c = (1 - Math.abs(2 * l - 1)) * s;
                const x = c * (1 - Math.abs((h / 60) % 2 - 1));
                const m = l - c / 2;

                let r = 0, g = 0, b = 0;
                if (0 <= h && h < 60) { r = c; g = x; b = 0; }
                else if (60 <= h && h < 120) { r = x; g = c; b = 0; }
                else if (120 <= h && h < 180) { r = 0; g = c; b = x; }
                else if (180 <= h && h < 240) { r = 0; g = x; b = c; }
                else if (240 <= h && h < 300) { r = x; g = 0; b = c; }
                else { r = c; g = 0; b = x; }

                const R = Math.round((r + m) * 255);
                const G = Math.round((g + m) * 255);
                const B = Math.round((b + m) * 255);

                const toHex = v => v.toString(16).padStart(2, '0');
                return `#${toHex(R)}${toHex(G)}${toHex(B)}`;
            }

            // Добавляет шум в HSL и возвращает HEX
            function jitterHex(baseHex, dh = 0, ds = 0, dl = 0) {
                const { h, s, l } = hexToHSL(baseHex);
                const nh = h + (Math.random() * 2 * dh - dh);
                const ns = clamp(s + (Math.random() * 2 * ds - ds), 0, 100);
                const nl = clamp(l + (Math.random() * 2 * dl - dl), 0, 100);
                return hslToHex(nh, ns, nl);
            }

            // Колонны и сферы
            // Создает колонну из сфер, растущую из заданной точки
            function createSphereColumn(centerx, centery, centerz, radius, length, container) {
                container = document.getElementById(container);
                container.innerHTML = '';

                for (let i = 0; i < length / 0.1; i++) {
                    const z = centerz + (Math.abs(50 - i) / 100 * Math.random() * radius * 4);
                    const x = centerx + (Math.abs(50 - i) / 100 * Math.random() * radius * 4);
                    const y = centery + (length / 100) * i;

                    const sphere = document.createElement('a-sphere');
                    sphere.setAttribute('position', { x: x, y: y, z: z });
                    sphere.setAttribute('radius', radius / 2 + radius * Math.abs(50 - i) / 100);

                    // Базовый тёмный оттенок + лёгкий шум
                    const base = '#2a2e28';
                    const color = jitterHex(base, 4, 4, 4);
                    sphere.setAttribute('color', color);

                    container.appendChild(sphere);
                }
            }

            createSphereColumn(-5, 0, -6, 2, 20, 'column-sphere-container1');
            createSphereColumn(10, 0, 13, 1, 15, 'column-sphere-container2');
            createSphereColumn(-4, 0, 9, 1, 20, 'column-sphere-container3');

            // Создает «сферу из сфер», расходящуюся от центра
            function createSphereSphere(radius, sphereSize, sphereCount) {
                const container = document.getElementById('cube-sphere-container');
                container.innerHTML = '';

                for (let i = 0; i < sphereCount; i++) {
                    // Сферические координаты
                    const theta = Math.random() * Math.PI * 2;
                    const phi = Math.acos(2 * Math.random() - 1);

                    // В декартовы координаты
                    const x = radius * Math.sin(phi) * Math.cos(theta);
                    const y = radius * Math.sin(phi) * Math.sin(theta);
                    const z = radius * Math.cos(phi);

                    const sphere = document.createElement('a-sphere');
                    sphere.setAttribute('position', { x: x, y: y, z: z });
                    sphere.setAttribute('radius', sphereSize * Math.random() * 2);

                    // Тёмная база + небольшой шум
                    const base = '#3a352a';
                    const color = jitterHex(base, 6, 6, 6);
                    sphere.setAttribute('color', color);

                    container.appendChild(sphere);
                }
            }

            // Создаем «сферу из сфер»
            createSphereSphere(30, 6, 1000);

            // СТАЛАКТИТЫ / СТАЛАГМИТЫ
            function createColumn(x, z, baseRadius, topRadius, startY, endY, container, baseColorHex) {
                const steps = 30;
                const yStep = (endY - startY) / steps;

                for (let i = 0; i < steps; i++) {
                    const y = startY + i * yStep;
                    const radius = baseRadius - (baseRadius - topRadius) * (i / steps);

                    const sphere = document.createElement('a-sphere');
                    sphere.setAttribute('position', {
                        x: x + (Math.random() - 0.5) * 0.4,
                        y: y,
                        z: z + (Math.random() - 0.5) * 0.4
                    });
                    sphere.setAttribute('radius', radius);

                    // Аккуратная вариация вокруг базового тёмного
                    const color = jitterHex(baseColorHex, 5, 5, 6);
                    sphere.setAttribute('color', color);

                    container.appendChild(sphere);
                }
            }

            // Создаем рандомно сталагмиты и сталактиты
            const stalagContainer = document.getElementById('stalag-container');
            const caveHeight = 15;
            const stalagmitesCount = 6;
            const stalactitesCount = 7;

            // Сталагмиты (база #0c1210)
            for (let i = 0; i < stalagmitesCount; i++) {
                const x = (Math.random() - 0.5) * 40;
                const z = (Math.random() - 0.5) * 40;
                const baseR = 1 + Math.random() * 1;
                const topR = 0.2 + Math.random() * 0.3;
                const height = 5 + Math.random() * 7;
                createColumn(x, z, baseR, topR, 0, height, stalagContainer, '#0c1210');
            }

            // Сталактиты (база #24231f)
            for (let i = 0; i < stalactitesCount; i++) {
                const x = (Math.random() - 0.5) * 40;
                const z = (Math.random() - 0.5) * 40;
                const baseR = 1 + Math.random() * 1;
                const topR = 0.2 + Math.random() * 0.3;
                const drop = 4 + Math.random() * 7;
                createColumn(x, z, baseR, topR, caveHeight, caveHeight - drop, stalagContainer, '#24231f');
            }

            function create_waterdrop(count,radius) {
                // Найти все сферы и цилиндры в пещере (сталактиты и сталагмиты)
                const caveElements = document.querySelectorAll('a-sphere, a-cylinder, a-cone');
                
                for (let i = 0; i < count; i++) {
                    const theta = Math.random() * Math.PI * 2;
                    const phi = Math.acos(2 * Math.random() - 1);

                    // В декартовы координаты
                    const x = radius * Math.sin(phi) * Math.cos(theta);
                    const y = Math.abs(radius * Math.sin(phi) * Math.sin(theta));
                    const z = radius * Math.cos(phi);
                    
                    // Позиция для капли
                    const dropPosition = {
                    x: x,
                    y: y,
                    z: z
                    };
                    // Создать контейнер для капли с анимацией
                    const dropContainer = document.createElement('a-entity');
                    dropContainer.setAttribute('position', dropPosition);
                    
                    // Создать визуальное представление капли (маленькая сфера)
                    const waterDrop = document.createElement('a-sphere');
                    waterDrop.setAttribute('radius', 0.1);
                    waterDrop.setAttribute('color', '#4FA4F7');
                    waterDrop.setAttribute('transparent', 'true');
                    waterDrop.setAttribute('opacity', '0.8');
                    
                    // Добавить анимацию падения :cite[1]
                    waterDrop.setAttribute('animation', {
                    property: 'position',
                    from: {x: 0, y: 0, z: 0},
                    to: {x: 0, y: -30, z: 0}, // Падение на 2 метра вниз
                    dur: 2000 + Math.random() * 3000, // Случайная длительность
                    easing: 'easeInQuad',
                    loop: true
                    });
                    
                    // Анимация исчезновения в конце падения
                    waterDrop.setAttribute('animation__opacity', {
                    property: 'opacity',
                    from: 0.8,
                    to: 0.2,
                    dur: 5000,
                    delay: 2000, // Начинать исчезать перед концом падения
                    easing: 'easeInQuad',
                    loop: true
                    });
                    
                    // Добавить каплю в контейнер и на сцену
                    dropContainer.appendChild(waterDrop);
                    document.querySelector('a-scene').appendChild(dropContainer);
                }
            }

        // Использование функции - создать 10 капель
            create_waterdrop(50,30);
        });
    </script>
</body>
</html>
